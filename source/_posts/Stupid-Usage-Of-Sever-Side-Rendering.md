---
title: 不会用还不如不用！关于服务器渲染的小故事
date: 2017-09-14 20:46:51
tags:
- front-end
- node
- server-side
- render
---

去年转行做前端的第一个项目就用到了 Node + Vue 的技术栈开发 Web 应用，听起来挺高大上的，毕竟在那之前我只用过 jQuery，在 Apache 服务器上零碎写过一些页面。尤其是 Node 服务器，采用集团内的一款框架，基于 KOA，针对集团业务集成了很多插件，用起来只能喊「6」。

开发的过程中虽然试图了解各种技术的方方面面，但是时间有限，业务当前，也只能先做到老生常谈的「 **先跑起来再说** 」。然而跑起来后，再如何精进，还是要回归对技术的思考。今天就要说一个这样的小故事。

## 一、故事的起因

集团的框架内置了一款名为 XTemplate 的模板引擎，如果你有前端开发经验，说这是一款类似 Nunjucks 的轮子你肯定就秒懂了。那时候作为小白的我看了这玩意，说不就是 HTML 的变种，用一些脚本让 HTML 写起来更方便嘛。也问过师兄， **为啥要在服务器端渲染，在客户端浏览器中渲染不是人之常情么？**

我也忘了师兄当初怎么回答，反正那时的我们肯定没有理解透彻这项技术，导致我们写出了这样的代码：页面顶栏的菜单选项和用户登录信息使用了 XTemplate 渲染，而下方的表格内容使用了 Vue 渲染，两种语法交融在 `.xtpl` 文件中。当访问请求触发后，XTemplate 将顶栏渲染好的页面返回给客户端，再由客户端的 Vue 代码进行异步请求表格数据，最后再完成表格的渲染。

由于业务一直对页面性能没有很高的要求，这套方案大家都觉得没啥问题，后来也用到了内存泄漏分析网站的开发中。只是长期困扰在我心头的，是一个一闪而过的画面： **当登入、刷新页面时，可以看到页面上没有数据，而是一些排列整齐的{% raw %}「{{}}」{% endraw %}符号一闪而过。** 熟悉 Vue 的同学看到这应该秒懂，{% raw %}「{{}}」{% endraw %}是 Vue 变量在 HTML 模板中使用的语法。


## 二、故事的经过

时过境迁，我换到了一个完全没有前端工程基础的团队，打造一套高效的前端开发体系是首要目标，只有架子搭起来了，未来才能更好地服务于业务。过去的前端框架自然是要参考的，但我也开始有了自己的思考，譬如哪些技术对业务是有价值的，哪些是可以替换甚至省略掉的。然后就思考到了服务器渲染这一技术。

现在回头看当初的设计，很轻松就能问出两个（更多..）问题：

- 既然客户端要异步请求表格数据，为何一开始不直接存在 DOM 中发过去？
- 需要 Vue 渲染的内容，能不能用模板引擎（如 XTemplate）渲染？如果能为什么要留到客户端渲染？

其实只要有这样的思考，就能大致推敲出服务器渲染的主要价值之一： **提高首屏渲染速度，节省额外请求首屏数据的时间。** 而我们之前的那种做法，完全废掉了这项技术，相比单纯的客户端渲染还浪费了服务器上模板引擎解析的时间（虽然从理论上这个时间消耗很短）。

因此使用服务器渲染的原则应当是尽量把页面所需的数据都渲染或存在页面中，能节省一次或多次 HTTP 请求时间；需要大量数据的图表是个例外，但这种情况更合适的做法应该是首次粗粒度显示、后续再异步请求调整吧。另外能在服务器端渲染的内容尽量使用模板引擎渲染，后续客户端的工作再交由 Vue 等框架来做。

## 三、故事的结果

这里使用 Chrome DevTools 简单验证上述想法，仅测试文件大小和数据加载的总时长（对于前后端渲染速度的比较有机会再测试）。

测试的页面包含三个基本的表格及一个相对复杂的图表，所需的数据存为 JSON 文件后大小 21 K。

- 当正确使用服务器渲染，把图表数据存在 DOM 中时，HTML 文件大小为 29.7KB，网络请求时间一般在 30 毫秒左右浮动；
- 当采用前文所描述的错误方法进行渲染，HTML 文件大小为 5.2KB，HTML 网络请求时间同样在 30 毫秒左右浮动，但是多了一次异步请求，耗时 110-130 毫秒。

不出意料，单从数据加载角度看，服务器端的做法已经秒杀哪怕只是多一次的异步请求。需要注意的是这个测试的服务器运行在本地，如果是请求未使用 CDN 的外部服务器，差距将被进一步扩大。至于两端的渲染速度，没有数据无法下定论，但是服务器端的运算能力还是有一定保证的。

## 四、后记

其实加载时间多一百毫秒甚至几百毫秒，对很多用户来说都是无感的。对不理解前端的人来说，提升百来毫秒，他们也会觉得现在客户端硬件如此发达，纠结这种问题的意义不是很大。忽略掉这种声音，我只想点出标题的感慨：

### **任何成熟技术的存在都是有诉求的，想不清楚真的还不如不用！！！**
